<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="UTF-8">
        <title>同步计划</title>
        <link href="/easyui/themes/icon.css" rel="stylesheet"/>
        <link href="/easyui/themes/bootstrap/easyui.css" rel="stylesheet"/>
        <script src="/easyui/jquery.min.js"></script>
        <script src="/easyui/jquery.easyui.min.js"></script>
        <script src="/easyui/locale/easyui-lang-zh_CN.js"></script>
        <script src="/js/layer.js"></script>
    </head>
    <style>
        xmp {
            font-family: "Ubuntu Mono", serif !important;
        }


        /*.datagrid-row-selected {*/
        /*    background: #ffffff;*/
        /*    color: #303030;*/
        /*}*/

        /*.datagrid-row-over {*/
        /*    background: #ffffff;*/
        /*    color: #303030;*/
        /*}*/

        .plan_code_column {
            cursor: pointer;
            color: #5cadff;
        }

        textarea {
            outline: none;
            resize: none;
        }
    </style>
    <body>

        <!-- 表格 -->
        <div id="sync_res_tb"></div>

        <input type="hidden" id="hide_uuid" value="">

        <!-- 工具栏 -->
        <div id="toolbar">
            <hr color="#eee"/>

            <label>
                状态:
                <select id="syncStatus" class="easyui-combobox" name="syncStatus" style="width:100px;">
                    <option value="" name="">全部</option>
                    <option value="success" name="success">成功</option>
                    <option value="fail" name="fail">失败</option>
                </select>
            </label>
            <label>
                重试次数:
                <select id="repeatCount" class="easyui-combobox" name="repeatCount" style="width:100px;">
                    <option value="" name="">全部</option>
                    <option value="1" name="1">>=1次</option>
                    <option value="2" name="2">>=2次</option>
                    <option value="3" name="3">>=3次</option>
                    <option value="4" name="4">>=4次</option>
                    <option value="5" name="5">>=5次</option>
                    <option value="6" name="6">>=6次</option>
                </select>
            </label>

            <label>
                消息来源:
                <select id="msgSrc" class="easyui-combobox" name="msgSrc" style="width:100px;">
                    <option value="" name="">全部</option>
                    <option value="job" name="job">定时器同步</option>
                    <option value="rocket_mq" name="rocket_mq">rocketmq同步</option>
                    <option value="handle" name="handle">手动同步</option>
                </select>
            </label>

            <label>
                <input class="easyui-textbox" id="plan_code" style="width:200px;">
            </label>

            <label>
                <input class="easyui-textbox" id="keywords" style="width:250px;">
            </label>

            <label>
                创建时间:
                <input id="msgCreateTime" type="text" class="easyui-datetimebox" style="width: 150px">-
                <input id="msgEndTime" type="text" class="easyui-datetimebox" style="width: 150px">
            </label>


            <label>
                <div style="user-select: none" id="search_plan_btn" class="easyui-linkbutton"
                     data-options="iconCls:'icon-search'">搜索
                </div>
                <div style="user-select: none" id="rest_plan_btn" class="easyui-linkbutton"
                     data-options="iconCls:'icon-reload'">重置
                </div>
                <div style="user-select: none" id="repeat_sync_btn" class="easyui-linkbutton"
                     data-options="iconCls:'icon-standard-database-go'">重新同步
                </div>
                <div style="user-select: none" id="sign_success_btn" class="easyui-linkbutton"
                     data-options="iconCls:'icon-standard-accept'">标记成功
                </div>
            </label>


            <hr color="#eee"/>
        </div>

        <div id="sync_content"></div>
    </body>

    <script>

        function getBeforeDate(n) {
            let d = new Date();
            let year;
            let mon;
            let day;
            d.setDate(d.getDate() - n);
            year = d.getFullYear();
            mon = d.getMonth() + 1;
            day = d.getDate();
            return year + "-" + (mon < 10 ? ('0' + mon) : mon) + "-" + (day < 10 ? ('0' + day) : day);
        }


        $(function () {

            // 时间筛选初始化
            let start = getBeforeDate(30) + " 00:00:00";
            let end = getBeforeDate(0) + " 23:59:59";
            $('#msgCreateTime').datetimebox('setValue', start);
            $('#msgEndTime').datetimebox('setValue', end);


            let table = $('#sync_res_tb');

            $("#search_plan_btn").linkbutton({
                onClick: function () {
                    table.datagrid('load', {
                        planCode: $("#plan_code").val(),
                        keywords: $("#keywords").val(),
                        syncStatus: $("#syncStatus").val(),
                        msgSrc: $("#msgSrc").val(),
                        startTime: $('#msgCreateTime').datetimebox('getValue'),
                        endTime: $('#msgEndTime').datetimebox('getValue'),
                        repeatCount: $("#repeatCount").val(),
                    })
                }
            })


            // 重置
            $("#rest_plan_btn").linkbutton({
                onClick: function () {
                    $("#plan_code").textbox('clear');
                    $("#keywords").textbox('clear');
                    $("#syncStatus").textbox('clear');
                    $("#repeatCount").textbox('clear');
                    $("#msgSrc").textbox('clear');
                    $('#msgCreateTime').datetimebox('setValue', start);
                    $('#msgEndTime').datetimebox('setValue', end);
                    table.datagrid("load", {
                        startTime: start,
                        endTime: end,
                    });
                    table.datagrid('clearChecked');
                }
            })

            // 重新同步
            $("#repeat_sync_btn").linkbutton({
                onClick: function () {

                    let item = table.datagrid("getSelected");
                    if (!item || item.status !== 'fail') {

                        return layer.alert('请选择同步失败的记录!', {icon: 0, closeBtn: 0}, function (index) {

                            table.datagrid("clearChecked")
                            layer.close(index);
                        });
                    }

                    layer.confirm('风险操作,请确认是否继续操作？', {
                        btn: ['确定同步', '取消操作']
                    }, function () {
                        $.get("/sync/result/repeat/sync?uuid=" + item.uuid, function (obj) {

                            if (obj.code === 200) {

                                layer.alert("重新同步成功",{icon:1},function (index) {

                                    table.datagrid("reload");
                                    table.datagrid('clearChecked');
                                    layer.close(index);
                                })
                            } else {

                                $.messager.alert('错误', obj.msg, 'error');
                            }

                        }, "json");

                    }, function () {
                        layer.msg('已取消操作', {icon: 1});
                    });

                }
            })

            // 标记成功
            $("#sign_success_btn").linkbutton({

                onClick: function () {

                    let item = table.datagrid("getSelected");
                    if (!item || item.status !== 'fail') {

                        return layer.alert('请选择同步失败的记录标记!', {icon: 0, closeBtn: 0}, function (index) {

                            table.datagrid("clearChecked")
                            layer.close(index);
                        });
                    }

                    layer.confirm('风险操作,请确认是否继续操作？', {
                        btn: ['确定标记', '取消操作']
                    }, function () {

                        $.get("/sync/result/sign/success?uuid=" + item.uuid, function (obj) {
                            if (obj.code === 200) {
                                table.datagrid("reload");
                                table.datagrid('clearChecked');
                            } else {
                                $.messager.alert('错误', obj.msg, 'error');
                            }
                        }, "json");
                    }, function () {
                        layer.msg('已取消操作', {icon: 1});
                    });
                }
            })


            $('#keywords').textbox({
                label: '关键词:',
                labelPosition: 'before',
                labelWidth: 50,
                prompt: '同步名称,消息内容,同步内容'
            });

            $('#plan_code').textbox({
                label: '计划编号:',
                labelPosition: 'before',
                labelWidth: 60,
                prompt: '请输入计划编号查询'
            });

            table.datagrid({
                url: '/sync/result/search',
                method: 'POST',
                idField: 'uuid',
                queryParams: {
                    startTime: start,
                    endTime: end,
                },
                striped: true,
                fitColumns: true,
                singleSelect: true,
                checkOnSelect: true,
                selectOnCheck: true,
                rownumbers: false,
                pagination: true,
                nowrap: false,
                pageSize: 20,
                toolbar: '#toolbar',
                pageList: [20, 50, 100, 150, 200],
                beforePageText: '第',
                afterPageText: '页    共 {pages} 页',
                displayMsg: '当前显示 {from} - {to} 条记录   共 {total} 条记录',
                showFooter: true,
                columns: [[
                    {field: 'msgId', checkbox: true},
                    // {field: 'msgId',title: '消息id', width: 100, align: 'center'},
                    {field: 'planCode', title: '计划编号', width: 250, align: 'center'},
                    {field: 'planName', title: '计划名称', width: 150, align: 'center'},
                    {field: 'srcProject', title: '源系统', width: 100, align: 'center'},
                    {field: 'destProject', title: '目标系统', width: 100, align: 'center'},
                    {field: 'msgSrc', title: '消息来源', width: 120, align: 'center'},
                    {
                        field: 'status', title: '同步状态', width: 80, align: 'center', formatter: function (value, row) {
                            return `${value === 'success' ? '<span style="color: #19be6b; ">成功</span>' : '<span style="color: red; ">失败</span>'}`;
                        }
                    },
                    {
                        field: 'syncContent',
                        title: '同步内容',
                        width: 200,
                        align: 'center',
                        formatter: function (value, row) {
                            return `<div class="show_sync_content" style="font-family:'Ubuntu Mono',serif;font-size: 13px;cursor: pointer; overflow: hidden;text-overflow: ellipsis;white-space: nowrap;">${value ? value : ''}</div>`;
                        }
                    },
                    {
                        field: 'msgContent',
                        title: '消息内容',
                        width: 200,
                        align: 'center',
                        formatter: function (value, row) {
                            return `<div class="show_msg_content" style="font-family:'Ubuntu Mono',serif;font-size:13px;cursor: pointer; overflow: hidden;text-overflow: ellipsis;white-space: nowrap;">${value}</div>`;
                        }
                    },
                    {field: 'remark', title: '备注信息', width: 100, align: 'center'},
                    {field: 'repeatCount', title: '重试次数', width: 80, align: 'center'},
                    {field: 'msgCreateTime', title: '消息创建时间', width: 150, align: 'center'},
                    {field: 'syncTime', title: '同步时间', width: 150, align: 'center'},
                ]],
                onLoadError: function (data) {
                },
                onLoadSuccess: function () {

                }
            });

        });
    </script>
</html>