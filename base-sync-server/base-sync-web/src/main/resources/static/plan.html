<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>同步计划</title>
    <link href="/easyui/themes/icon.css" rel="stylesheet" />
    <link href="/easyui/themes/bootstrap/easyui.css" rel="stylesheet" />
    <script src="/easyui/jquery.min.js"></script>
    <script src="/easyui/locale/easyui-lang-zh_CN.js"></script>
    <script src="/easyui/jquery.easyui.min.js"></script>
</head>
<style>
    xmp{
        font-family: "Ubuntu Mono",serif !important;
    }
    .datagrid-row-selected {
        background: #ffffff;
        color: #303030;
    }
    .datagrid-row-over{
        background: #ffffff;
        color: #303030;
    }
    textarea{
        outline: none;
        resize: none;
    }
</style>
<body>

<!-- 表格 -->
<div id="sync_plan_tb"></div>
</body>

<!-- 同步内容显示弹框 -->
<div id="add_content_dialog" style="font-size: 14px;!important;background-color: #ffffff">
    <textarea id="add_content" style="width: 100%;height: 95%;font-size: 15px;border:1px #eeeeee solid;font-family: 'Ubuntu Mono'"></textarea>
</div>

<!-- 同步内容编辑弹框 -->
<div id="edit_content_dialog" style="font-size: 14px;!important;background-color: #ffffff">
    <textarea id="edit_content" style="width: 100%;height: 95%;font-size: 15px;border:1px #eeeeee solid;font-family: 'Ubuntu Mono'"></textarea>
</div>

<input type="hidden" id="hide_uuid" value="">

<!-- 工具栏 -->
<div id="toolbar">

    <a  class="easyui-linkbutton" iconCls="icon-add" plain="false" id="add_plan_btn">新增</a>
    <a  class="easyui-linkbutton" iconCls="icon-mini-refresh" plain="false" id="refresh_plan_btn">刷新</a>
    <hr/>

    <label>
        <input class="easyui-textbox" data-options="iconCls:'icon-search'">
    </label>
</div>

<script>

    $(function () {
        let table = $('#sync_plan_tb').datagrid({
            url: '/sync/plan/page',
            method: 'POST',
            idField: 'uuid',
            striped: false,
            fitColumns: true,
            singleSelect: false,
            checkOnSelect: false,
            selectOnCheck: true,
            rownumbers: true,
            pagination: true,
            nowrap: false,
            pageSize: 15,
            toolbar: '#toolbar',
            pageList: [15, 50, 100, 150, 200],
            showFooter: true,
            columns: [[
                {field: 'uuid', checkbox: true},
                {field: 'planCode', title: '同步计划编号', width: 200, align: 'center'},
                {field: 'srcDb', title: '源数据库', width: 180, align: 'center'},
                {field: 'destDb', title: '目标数据库', width: 180, align: 'center'},
                {field: 'srcProject', title: '源系统', width: 180, align: 'center'},
                {field: 'destProject', title: '目标系统', width: 180, align: 'center'},
                {
                    field: 'status', title: '启用状态', width: 150, align: 'center', formatter: function (value) {
                        return value === 'normal' ? "<font color='#19be6b'>启用</font>" : "<font color='red'>禁用</font>";
                    }
                },
                {field: 'createTime', title: '创建时间', width: 200, align: 'center'},
                {field: 'updateTime', title: '更新时间', width: 200, align: 'center'},
                {field: 'opBtn', title: '操作', width: 250, align: 'center',formatter: function (value,row) {
                        return "<a class=\"edit_plan_btn\">编辑</a>&nbsp;&nbsp;<a class=\"status_plan_btn\">状态</a></a>";
                    }},
            ]],
            onLoadSuccess:function () {

                // 启用禁用同步计划
                $(".status_plan_btn").linkbutton({
                    plain: false,
                    iconCls: 'icon-lock',
                    onClick: function () {

                        let uuid = $(this).parent().parent().parent().children().eq(0).find("input").val();

                        $.messager.confirm('是否继续操作?','您是否要更新该同步计划的状态?',function(r){
                            if (r){
                                $.get("/sync/plan/status?uuid="+ uuid,function(obj){
                                    if(obj.code === 200){

                                        table.datagrid("reload")

                                    }else {
                                        $.messager.alert('错误',obj.msg,'info');
                                    }
                                },"json");
                            }
                        });

                    }
                });

                // 编辑同步计划
                $(".edit_plan_btn").linkbutton({
                    plain: false,
                    iconCls: 'icon-edit',
                    onClick: function () {

                        let uuid = $(this).parent().parent().parent().children().eq(0).find("input").val();

                        $.get("/sync/plan/content?uuid=" + uuid, function (obj) {

                            if(obj.code === 200){

                                $("#edit_content").text(obj.result);
                                $('#edit_content_dialog').dialog({
                                    closed: false,
                                })
                                $("#hide_uuid").val(uuid);
                            }

                        }, "json");
                    }
                });
            }
        });

        /**
         * 生效编辑弹框
         *
         * @returns {*}
         */
        $('#edit_content_dialog').dialog({
            title: '编辑同步计划',
            width: 800,
            height: 600,
            closed: true,
            iconCls: 'icon-edit',
            cache: false,
            modal: true,
            toolbar:[{
                text:'保存',
                iconCls:'icon-save',
                handler:function(){
                    let content = $("#edit_content").val();
                    let uuid = $("#hide_uuid").val();

                    let params = {uuid:uuid,planContent: content};

                    $.ajax({
                        url:"/sync/plan/update",
                        data:JSON.stringify(params),
                        dataType:"json",
                        contentType: "application/json;charset=utf-8",
                        type:"POST",
                        success:function (res){
                           if(res.code === 200){

                               $('#edit_content_dialog').dialog({
                                   closed: true,
                               })
                               table.datagrid("reload")

                           }else {
                               $.messager.alert('错误',res.msg,'info');
                           }
                        }

                    });

                }
            }]
        });

        /**
         * 刷新表格
         *
         * @returns {*}
         */
        $("#refresh_plan_btn").click(function () {
           table.datagrid("reload")
        })


        /**
         * 新增弹框
         *
         * @returns {*}
         */
        $("#add_plan_btn").click(function () {

            $('#add_content_dialog').dialog({
                title: '新增同步计划',
                width: 800,
                height: 600,
                closed: false,
                cache: false,
                modal: true,
                toolbar:[{
                    text:'新增',
                    iconCls:'icon-save',
                    handler:function(){
                        let content = $("#add_content").val();
                        let params = {planContent: content};
                        $.ajax({
                            url:"/sync/plan/save",
                            data:JSON.stringify(params),
                            dataType:"json",
                            contentType: "application/json;charset=utf-8",
                            type:"POST",
                            success:function (res){
                                if(res.code === 200){

                                    $('#add_content_dialog').dialog({
                                        closed: true,
                                    })
                                    $("#add_content").val('');
                                    table.datagrid("reload")

                                }else {
                                    $.messager.alert('错误',res.msg,'info');
                                }
                            }

                        });

                    }
                }]
            })
        })

    })
</script>
</html>